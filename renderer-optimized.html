<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PlanFlow - 智能日程管理</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            height: 100vh;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 12px;
            margin: 8px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);
        }

        /* 侧边栏 */
        .sidebar {
            width: 280px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 12px 0 0 12px;
            padding: 24px;
            box-shadow: 2px 0 20px rgba(0, 0, 0, 0.1);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 32px;
            padding-bottom: 24px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .logo h1 {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .nav-menu {
            list-style: none;
            margin-bottom: 32px;
        }

        .nav-item {
            margin-bottom: 8px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            text-decoration: none;
            color: #6b7280;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-weight: 500;
            cursor: pointer;
        }

        .nav-link:hover, .nav-link.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            transform: translateX(4px);
        }

        .nav-icon {
            width: 20px;
            height: 20px;
        }

        .quick-add {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .quick-add:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
        }

        /* 主内容区 */
        .main-content {
            flex: 1;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 0 12px 12px 0;
            padding: 32px;
            overflow-y: auto;
            position: relative;
        }

        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }

        .header h2 {
            font-size: 28px;
            font-weight: 700;
            color: #1f2937;
        }

        .date-info {
            color: #6b7280;
            font-size: 16px;
            margin-top: 4px;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: rgba(107, 114, 128, 0.1);
            color: #6b7280;
            border: 1px solid rgba(107, 114, 128, 0.2);
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        /* 优化的样式 - 减少重绘 */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
            will-change: contents;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            padding: 24px;
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: transform 0.3s ease;
            will-change: transform;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        /* 性能优化 - 使用transform代替layout变化 */
        .loading {
            opacity: 0.5;
            pointer-events: none;
            transition: opacity 0.2s ease;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- 侧边栏 -->
        <div class="sidebar">
            <div class="logo">
                <div class="logo-icon">P</div>
                <h1>PlanFlow</h1>
            </div>

            <nav class="nav-menu">
                <div class="nav-item">
                    <a href="#" class="nav-link active" data-view="dashboard">
                        <span class="nav-icon">📊</span>
                        今日概览
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#" class="nav-link" data-view="calendar">
                        <span class="nav-icon">📅</span>
                        日历视图
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#" class="nav-link" data-view="tasks">
                        <span class="nav-icon">✅</span>
                        任务列表
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#" class="nav-link" data-view="projects">
                        <span class="nav-icon">📋</span>
                        项目管理
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#" class="nav-link" data-view="diary">
                        <span class="nav-icon">📔</span>
                        日记本
                    </a>
                </div>
            </nav>

            <button class="quick-add" onclick="showAddTaskModal()">
                ➕ 快速添加任务
            </button>
        </div>

        <!-- 主内容区 -->
        <div class="main-content">
            <!-- 今日概览 -->
            <div id="dashboard" class="view active">
                <div class="header">
                    <div>
                        <h2>今日概览</h2>
                        <div class="date-info"></div>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>📝 待办任务</h3>
                        <div class="stat-number" id="pending-tasks">0</div>
                        <p>个任务待完成</p>
                    </div>
                    <div class="stat-card">
                        <h3>✅ 已完成</h3>
                        <div class="stat-number" id="completed-tasks">0</div>
                        <p>个任务已完成</p>
                    </div>
                    <div class="stat-card">
                        <h3>📊 项目进度</h3>
                        <div class="stat-number" id="active-projects">0</div>
                        <p>个项目进行中</p>
                    </div>
                    <div class="stat-card">
                        <h3>⚡ 完成率</h3>
                        <div class="stat-number" id="completion-rate">0%</div>
                        <p>今日完成率</p>
                    </div>
                </div>

                <div id="today-tasks">
                    <h3>今日重要任务</h3>
                    <div id="today-task-list"></div>
                </div>
            </div>

            <!-- 任务列表视图 -->
            <div id="tasks" class="view">
                <div class="header">
                    <h2>任务管理</h2>
                    <button class="btn btn-primary" onclick="showAddTaskModal()">新建任务</button>
                </div>
                <div id="task-list"></div>
            </div>

            <!-- 项目管理视图 -->
            <div id="projects" class="view">
                <div class="header">
                    <h2>项目管理</h2>
                    <button class="btn btn-primary" onclick="showAddProjectModal()">新建项目</button>
                </div>
                <div id="project-list"></div>
            </div>

            <!-- 日历视图 -->
            <div id="calendar" class="view">
                <div class="header">
                    <h2>日历视图</h2>
                </div>
                <div id="calendar-container"></div>
            </div>

            <!-- 日记视图 -->
            <div id="diary" class="view">
                <div class="header">
                    <h2>我的日记</h2>
                    <button class="btn btn-primary" onclick="showAddDiaryModal()">写日记</button>
                </div>
                <div id="diary-list"></div>
            </div>
        </div>
    </div>

    <script>
        // 性能优化的应用数据管理
        class OptimizedAppData {
            constructor() {
                this.data = {
                    currentDate: new Date(),
                    tasks: [],
                    projects: [],
                    diaries: []
                };
                this.cache = new Map();
                this.isDirty = false;
                this.saveTimer = null;
            }

            // 延迟保存 - 避免频繁I/O
            scheduleSave() {
                this.isDirty = true;
                if (this.saveTimer) {
                    clearTimeout(this.saveTimer);
                }
                this.saveTimer = setTimeout(() => {
                    this.save();
                }, 500); // 500ms延迟保存
            }

            async save() {
                if (!this.isDirty) return;
                
                try {
                    if (isElectron) {
                        await window.electronAPI.saveData(this.data);
                    } else {
                        localStorage.setItem('planflow-data', JSON.stringify(this.data));
                    }
                    this.isDirty = false;
                } catch (error) {
                    console.error('保存数据失败:', error);
                }
            }

            async load() {
                try {
                    if (isElectron) {
                        const result = await window.electronAPI.loadData();
                        if (result.success && result.data) {
                            this.data = result.data;
                            this.convertDateFields();
                            return;
                        }
                    }
                    
                    const saved = localStorage.getItem('planflow-data');
                    if (saved) {
                        this.data = JSON.parse(saved);
                        this.convertDateFields();
                    }
                } catch (error) {
                    console.error('加载数据失败:', error);
                }
            }

            convertDateFields() {
                this.data.currentDate = new Date(this.data.currentDate);
                this.data.tasks.forEach(task => {
                    if (task.dueDate) task.dueDate = new Date(task.dueDate);
                    if (task.createdAt) task.createdAt = new Date(task.createdAt);
                });
                this.data.projects.forEach(project => {
                    if (project.dueDate) project.dueDate = new Date(project.dueDate);
                    if (project.createdAt) project.createdAt = new Date(project.createdAt);
                });
                this.data.diaries.forEach(diary => {
                    if (diary.date) diary.date = new Date(diary.date);
                });
            }

            // 缓存优化的数据获取
            getTodayTasks() {
                const cacheKey = 'todayTasks-' + new Date().toDateString();
                if (this.cache.has(cacheKey)) {
                    return this.cache.get(cacheKey);
                }

                const today = new Date();
                const todayTasks = this.data.tasks.filter(task => {
                    if (!task.dueDate) return false;
                    return task.dueDate.toDateString() === today.toDateString();
                });

                this.cache.set(cacheKey, todayTasks);
                return todayTasks;
            }

            clearCache() {
                this.cache.clear();
            }
        }

        // 初始化优化的数据管理器
        const appData = new OptimizedAppData();
        const isElectron = typeof window.electronAPI !== 'undefined';

        // 性能优化的渲染管理器
        class RenderManager {
            constructor() {
                this.renderQueue = new Set();
                this.rafId = null;
                this.isRendering = false;
            }

            scheduleRender(viewName) {
                this.renderQueue.add(viewName);
                if (!this.rafId) {
                    this.rafId = requestAnimationFrame(() => this.flushRenders());
                }
            }

            flushRenders() {
                if (this.isRendering) return;
                this.isRendering = true;

                for (const viewName of this.renderQueue) {
                    this.renderView(viewName);
                }

                this.renderQueue.clear();
                this.rafId = null;
                this.isRendering = false;
            }

            renderView(viewName) {
                const startTime = performance.now();
                
                try {
                    switch(viewName) {
                        case 'dashboard':
                            this.renderDashboard();
                            break;
                        case 'tasks':
                            this.renderTasks();
                            break;
                        case 'projects':
                            this.renderProjects();
                            break;
                        case 'calendar':
                            this.renderCalendar();
                            break;
                        case 'diary':
                            this.renderDiaries();
                            break;
                    }
                } catch (error) {
                    console.error(`渲染${viewName}失败:`, error);
                }

                const endTime = performance.now();
                if (endTime - startTime > 16) { // 超过16ms警告
                    console.warn(`${viewName}渲染耗时${endTime - startTime}ms`);
                }
            }

            renderDashboard() {
                const todayTasks = appData.getTodayTasks();
                const completedTasks = todayTasks.filter(task => task.status === 'completed');
                const pendingTasks = todayTasks.filter(task => task.status === 'pending');
                const activeProjects = appData.data.projects.filter(project => project.progress < 100);

                // 批量更新DOM
                const updates = [
                    ['pending-tasks', pendingTasks.length],
                    ['completed-tasks', completedTasks.length],
                    ['active-projects', activeProjects.length],
                    ['completion-rate', todayTasks.length ? Math.round((completedTasks.length / todayTasks.length) * 100) + '%' : '0%']
                ];

                updates.forEach(([id, value]) => {
                    const element = document.getElementById(id);
                    if (element && element.textContent !== value.toString()) {
                        element.textContent = value;
                    }
                });

                // 更新任务列表
                this.updateTaskList('today-task-list', todayTasks.slice(0, 5));
            }

            renderTasks() {
                this.updateTaskList('task-list', appData.data.tasks);
            }

            renderProjects() {
                const container = document.getElementById('project-list');
                if (!container) return;

                const html = appData.data.projects.map(project => `
                    <div class="project-card">
                        <h3>${project.title}</h3>
                        <p>${project.description}</p>
                        <div class="project-progress">
                            <div class="progress-bar" style="width: ${project.progress}%"></div>
                        </div>
                        <button onclick="deleteProject('${project.id}')">删除</button>
                    </div>
                `).join('');

                if (container.innerHTML !== html) {
                    container.innerHTML = html;
                }
            }

            renderCalendar() {
                // 简化的日历渲染
                const container = document.getElementById('calendar-container');
                if (!container) return;
                
                container.innerHTML = '<p>日历视图（简化版）</p>';
            }

            renderDiaries() {
                const container = document.getElementById('diary-list');
                if (!container) return;

                const html = appData.data.diaries.map(diary => `
                    <div class="diary-entry">
                        <h4>${diary.date.toLocaleDateString()}</h4>
                        <p>${diary.content}</p>
                    </div>
                `).join('');

                if (container.innerHTML !== html) {
                    container.innerHTML = html;
                }
            }

            updateTaskList(containerId, tasks) {
                const container = document.getElementById(containerId);
                if (!container) return;

                const html = tasks.map(task => `
                    <div class="task-item">
                        <input type="checkbox" ${task.status === 'completed' ? 'checked' : ''} 
                               onchange="toggleTaskStatus('${task.id}')">
                        <span class="${task.status === 'completed' ? 'completed' : ''}">${task.title}</span>
                        <button onclick="deleteTask('${task.id}')">删除</button>
                    </div>
                `).join('');

                if (container.innerHTML !== html) {
                    container.innerHTML = html;
                }
            }
        }

        const renderManager = new RenderManager();

        // 优化的事件处理
        function setupOptimizedEventListeners() {
            // 使用事件委托减少事件监听器数量
            document.addEventListener('click', function(e) {
                if (e.target.matches('.nav-link')) {
                    e.preventDefault();
                    const targetView = e.target.getAttribute('data-view');
                    showView(targetView);
                }
            });

            // 防抖的窗口resize事件
            let resizeTimer;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(() => {
                    renderManager.scheduleRender('dashboard');
                }, 250);
            });
        }

        function showView(viewId) {
            // 优化视图切换
            const views = document.querySelectorAll('.view');
            const navLinks = document.querySelectorAll('.nav-link');
            
            views.forEach(view => view.classList.remove('active'));
            navLinks.forEach(link => link.classList.remove('active'));
            
            document.getElementById(viewId).classList.add('active');
            document.querySelector(`[data-view="${viewId}"]`).classList.add('active');
            
            // 延迟渲染非活跃视图
            renderManager.scheduleRender(viewId);
        }

        // 优化的任务管理函数
        function addTask(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            
            const task = {
                id: Date.now().toString(),
                title: formData.get('title'),
                description: formData.get('description'),
                dueDate: formData.get('dueDate') ? new Date(formData.get('dueDate')) : null,
                priority: formData.get('priority'),
                status: 'pending',
                createdAt: new Date()
            };
            
            appData.data.tasks.push(task);
            appData.clearCache(); // 清除缓存
            appData.scheduleSave(); // 延迟保存
            
            form.reset();
            
            // 批量更新视图
            renderManager.scheduleRender('dashboard');
            renderManager.scheduleRender('tasks');
        }

        function deleteTask(taskId) {
            if (confirm('确定要删除这个任务吗？')) {
                appData.data.tasks = appData.data.tasks.filter(task => task.id !== taskId);
                appData.clearCache();
                appData.scheduleSave();
                
                renderManager.scheduleRender('dashboard');
                renderManager.scheduleRender('tasks');
            }
        }

        function toggleTaskStatus(taskId) {
            const task = appData.data.tasks.find(t => t.id === taskId);
            if (task) {
                task.status = task.status === 'completed' ? 'pending' : 'completed';
                appData.clearCache();
                appData.scheduleSave();
                
                renderManager.scheduleRender('dashboard');
                renderManager.scheduleRender('tasks');
            }
        }

        function deleteProject(projectId) {
            if (confirm('确定要删除这个项目吗？')) {
                appData.data.projects = appData.data.projects.filter(project => project.id !== projectId);
                appData.scheduleSave();
                renderManager.scheduleRender('projects');
            }
        }

        // 模拟弹窗函数（简化版）
        function showAddTaskModal() {
            const title = prompt('任务标题:');
            if (title) {
                const task = {
                    id: Date.now().toString(),
                    title: title,
                    description: '',
                    dueDate: null,
                    priority: 'medium',
                    status: 'pending',
                    createdAt: new Date()
                };
                
                appData.data.tasks.push(task);
                appData.clearCache();
                appData.scheduleSave();
                
                renderManager.scheduleRender('dashboard');
                renderManager.scheduleRender('tasks');
            }
        }

        function showAddProjectModal() {
            const title = prompt('项目标题:');
            if (title) {
                const project = {
                    id: Date.now().toString(),
                    title: title,
                    description: '',
                    dueDate: null,
                    progress: 0,
                    createdAt: new Date()
                };
                
                appData.data.projects.push(project);
                appData.scheduleSave();
                renderManager.scheduleRender('projects');
            }
        }

        function showAddDiaryModal() {
            const content = prompt('今天的日记:');
            if (content) {
                const diary = {
                    id: Date.now().toString(),
                    date: new Date(),
                    content: content
                };
                
                appData.data.diaries.push(diary);
                appData.scheduleSave();
                renderManager.scheduleRender('diary');
            }
        }

        // 初始化应用
        async function initApp() {
            try {
                await appData.load();
                setupOptimizedEventListeners();
                
                // 更新日期显示
                const dateInfo = document.querySelector('.date-info');
                const now = new Date();
                dateInfo.textContent = now.toLocaleDateString('zh-CN', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric', 
                    weekday: 'long' 
                });

                // 初始化仪表板
                renderManager.scheduleRender('dashboard');
                
            } catch (error) {
                console.error('应用初始化失败:', error);
            }
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', initApp);

        // 页面卸载前保存数据
        window.addEventListener('beforeunload', () => {
            appData.save();
        });
    </script>
</body>
</html> 