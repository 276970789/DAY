<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TyporaÈ£éÊ†ºÁºñËæëÂô® Demo - DAY</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #f0f7ff 0%, #e3f2fd 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .demo-container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .demo-header {
            background: linear-gradient(135deg, #7BB3F0, #5A9BD4);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .demo-title {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .demo-subtitle {
            opacity: 0.9;
            font-size: 16px;
        }

        .demo-content {
            padding: 30px;
        }

        /* TyporaÈ£éÊ†ºÁºñËæëÂô® */
        .typora-editor {
            border: 2px solid #e0e7ff;
            border-radius: 12px;
            overflow: hidden;
            background: white;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }

        .typora-toolbar {
            display: flex;
            gap: 8px;
            padding: 12px 16px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            flex-wrap: wrap;
            align-items: center;
        }

        .toolbar-group {
            display: flex;
            gap: 4px;
            padding-right: 12px;
            border-right: 1px solid #e2e8f0;
        }

        .toolbar-group:last-child {
            border-right: none;
        }

        .typora-toolbar button {
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            min-width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .typora-toolbar button:hover {
            background: #f1f5f9;
            border-color: #7BB3F0;
            color: #5A9BD4;
            transform: translateY(-1px);
        }

        .mode-toggle {
            margin-left: auto;
            background: #7BB3F0 !important;
            color: white !important;
            border-color: #7BB3F0 !important;
        }

        .mode-toggle:hover {
            background: #5A9BD4 !important;
        }

        /* ÁºñËæëÂô®ÂÆπÂô® */
        .editor-area {
            position: relative;
            min-height: 500px;
            max-height: 600px;
            overflow-y: auto;
        }

        /* ÂÆûÊó∂ÁºñËæëÂô® (TyporaÈ£éÊ†º) */
        .wysiwyg-editor {
            width: 100%;
            min-height: 500px;
            padding: 24px;
            border: none;
            outline: none;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-size: 16px;
            line-height: 1.7;
            color: #374151;
            resize: none;
            background: transparent;
        }

        /* Ê∫êÁ†ÅÁºñËæëÂô® */
        .source-editor {
            width: 100%;
            min-height: 500px;
            padding: 24px;
            border: none;
            outline: none;
            font-family: 'JetBrains Mono', 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 14px;
            line-height: 1.6;
            color: #374151;
            resize: none;
            background: #fafbfc;
            display: none;
            tab-size: 4;
            white-space: pre;
            word-wrap: break-word;
        }

        /* MarkdownÊ∏≤ÊüìÊ†∑Âºè */
        .wysiwyg-editor h1 {
            font-size: 32px;
            font-weight: 700;
            color: #1e293b;
            margin: 24px 0 16px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid #e2e8f0;
        }

        .wysiwyg-editor h2 {
            font-size: 24px;
            font-weight: 600;
            color: #1e293b;
            margin: 20px 0 12px 0;
        }

        .wysiwyg-editor h3 {
            font-size: 20px;
            font-weight: 600;
            color: #1e293b;
            margin: 16px 0 8px 0;
        }

        .wysiwyg-editor p {
            margin-bottom: 16px;
            color: #374151;
        }

        .wysiwyg-editor ul, .wysiwyg-editor ol {
            margin: 16px 0;
            padding-left: 24px;
        }

        .wysiwyg-editor li {
            margin-bottom: 8px;
            color: #374151;
        }

        .wysiwyg-editor .todo-list {
            list-style: none;
            padding-left: 0;
        }

        .wysiwyg-editor .todo-item {
            display: flex;
            align-items: center;
            padding: 6px 0;
            margin-bottom: 4px;
            position: relative;
        }

        .wysiwyg-editor .todo-checkbox {
            margin-right: 8px;
            margin-top: 0;
            transform: scale(1.2);
            cursor: pointer;
            flex-shrink: 0;
        }

        .wysiwyg-editor .todo-completed {
            text-decoration: line-through;
            color: #9ca3af;
        }

        .wysiwyg-editor strong {
            font-weight: 600;
            color: #1e293b;
        }

        .wysiwyg-editor em {
            font-style: italic;
            color: #7BB3F0;
        }

        .wysiwyg-editor code {
            background: #f1f5f9;
            color: #e11d48;
            padding: 3px 6px;
            border-radius: 4px;
            font-family: 'JetBrains Mono', 'Monaco', monospace;
            font-size: 14px;
        }

        .wysiwyg-editor blockquote {
            border-left: 4px solid #7BB3F0;
            padding-left: 16px;
            margin: 16px 0;
            color: #64748b;
            font-style: italic;
            background: #f8fafc;
            padding: 12px 16px;
            border-radius: 0 6px 6px 0;
        }

        .wysiwyg-editor hr {
            border: none;
            border-top: 2px solid #e2e8f0;
            margin: 24px 0;
        }

        /* ÈöêËóèÁöÑmarkdownËØ≠Ê≥ï */
        .wysiwyg-editor .md-syntax {
            color: #9ca3af;
            font-size: 0.9em;
            user-select: none;
        }

        /* Á§∫‰æãÂå∫Âüü */
        .examples {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .example-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
        }

        .example-title {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 8px;
        }

        .example-code {
            background: #1e293b;
            color: #e2e8f0;
            padding: 12px;
            border-radius: 6px;
            font-family: 'JetBrains Mono', 'Monaco', monospace;
            font-size: 12px;
            line-height: 1.5;
            white-space: pre-wrap;
            margin-bottom: 12px;
        }

        .try-button {
            background: #7BB3F0;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
        }

        .try-button:hover {
            background: #5A9BD4;
        }

        /* ÂìçÂ∫îÂºè */
        @media (max-width: 768px) {
            .examples {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="demo-container">
        <div class="demo-header">
            <h1 class="demo-title">üìù TyporaÈ£éÊ†ºÁºñËæëÂô®</h1>
            <p class="demo-subtitle">ÊâÄËßÅÂç≥ÊâÄÂæóÁöÑMarkdownÁºñËæë‰ΩìÈ™å</p>
        </div>
        
        <div class="demo-content">
            <!-- TyporaÈ£éÊ†ºÁºñËæëÂô® -->
            <div class="typora-editor">
                <div class="typora-toolbar">
                    <div class="toolbar-group">
                        <button onclick="undo()" title="Êí§ÈîÄ (Ctrl+Z)">‚Ü∂</button>
                        <button onclick="redo()" title="ÈáçÂÅö (Ctrl+Y)">‚Ü∑</button>
                    </div>
                    <div class="toolbar-group">
                        <button onclick="insertFormatting('**', '**', 'Á≤ó‰ΩìÊñáÂ≠ó')" title="Á≤ó‰Ωì">ùêÅ</button>
                        <button onclick="insertFormatting('*', '*', 'Êñú‰ΩìÊñáÂ≠ó')" title="Êñú‰Ωì">ùêº</button>
                        <button onclick="insertFormatting('`', '`', '‰ª£Á†Å')" title="Ë°åÂÜÖ‰ª£Á†Å">‚Äπ/‚Ä∫</button>
                    </div>
                    <div class="toolbar-group">
                        <button onclick="insertHeading(1)" title="‰∏ÄÁ∫ßÊ†áÈ¢ò">H1</button>
                        <button onclick="insertHeading(2)" title="‰∫åÁ∫ßÊ†áÈ¢ò">H2</button>
                        <button onclick="insertHeading(3)" title="‰∏âÁ∫ßÊ†áÈ¢ò">H3</button>
                    </div>
                    <div class="toolbar-group">
                        <button onclick="insertTodo(false)" title="ÂæÖÂäû‰∫ãÈ°π">‚òê</button>
                        <button onclick="insertTodo(true)" title="Â∑≤ÂÆåÊàê">‚òë</button>
                        <button onclick="insertList(false)" title="Êó†Â∫èÂàóË°®">‚Ä¢</button>
                        <button onclick="insertList(true)" title="ÊúâÂ∫èÂàóË°®">1.</button>
                    </div>
                    <div class="toolbar-group">
                        <button onclick="insertQuote()" title="ÂºïÁî®">‚ùù</button>
                        <button onclick="insertDivider()" title="ÂàÜÈöîÁ∫ø">‚Äï</button>
                    </div>
                    <button class="mode-toggle" onclick="toggleMode()" title="ÂàáÊç¢ÁºñËæëÊ®°Âºè">Ê∫êÁ†Å</button>
                </div>
                
                <div class="editor-area">
                    <div id="wysiwygEditor" class="wysiwyg-editor" contenteditable="true" placeholder="ÂºÄÂßãËæìÂÖ•ÊÇ®ÁöÑÂÜÖÂÆπ...">
                        <h1>Ê¨¢Ëøé‰ΩøÁî® TyporaÈ£éÊ†ºÁºñËæëÂô®</h1>
                        <p>ËøôÊòØ‰∏Ä‰∏™ÊâÄËßÅÂç≥ÊâÄÂæóÁöÑMarkdownÁºñËæëÂô®Ôºå‰ΩìÈ™åÂ∞±ÂÉè Typora ‰∏ÄÊ†∑ÔºÅ</p>
                        
                        <h2>ÂäüËÉΩÁâπËâ≤</h2>
                        <ul>
                            <li><strong>ÂÆûÊó∂È¢ÑËßà</strong>ÔºöËæπÂÜôËæπÁúãÊïàÊûú</li>
                            <li><em>ÁÆÄÊ¥ÅÁïåÈù¢</em>Ôºö‰∏ìÊ≥®‰∫éÂÜÖÂÆπÂàõ‰Ωú</li>
                            <li><code>ËØ≠Ê≥ïÈ´ò‰∫Æ</code>Ôºö‰ª£Á†ÅÊòæÁ§∫Ê∏ÖÊô∞</li>
                        </ul>
                        
                        <h3>ËØïËØïÂæÖÂäûÂàóË°®</h3>
                        <ul class="todo-list">
                            <li class="todo-item">
                                <input type="checkbox" class="todo-checkbox"> 
                                <span>ÂÜô‰∏ÄÁØáÂçöÂÆ¢ÊñáÁ´†</span>
                            </li>
                            <li class="todo-item">
                                <input type="checkbox" class="todo-checkbox" checked> 
                                <span class="todo-completed">ÂÆåÊàêÈ°πÁõÆÊñáÊ°£</span>
                            </li>
                        </ul>
                        
                        <blockquote>
                            üí° ÊèêÁ§∫ÔºöÁÇπÂáªÂ∑•ÂÖ∑Ê†èÊåâÈíÆÂø´ÈÄüÊèíÂÖ•Ê†ºÂºèÔºåÊàñÁõ¥Êé•ËæìÂÖ•MarkdownËØ≠Ê≥ïÔºÅ
                        </blockquote>
                    </div>
                    
                    <textarea id="sourceEditor" class="source-editor"></textarea>
                </div>
            </div>

            <!-- Á§∫‰æãÂå∫Âüü -->
            <h2 style="margin-bottom: 16px; color: #1e293b;">üìö Âø´ÈÄüÁ§∫‰æã</h2>
            <div class="examples">
                <div class="example-card">
                    <div class="example-title">üìã ‰ªªÂä°ÂàóË°®</div>
                    <div class="example-code"># ‰ªäÊó•‰ªªÂä°

- [ ] ÂõûÂ§çÈáçË¶ÅÈÇÆ‰ª∂
- [x] ÂÆåÊàêÈ°πÁõÆÊä•Âëä
- [ ] ÂáÜÂ§áÊòéÂ§©ÁöÑ‰ºöËÆÆ
- [x] Êõ¥Êñ∞ÊñáÊ°£

**ËøõÂ∫¶**: 50% ÂÆåÊàê</div>
                    <button class="try-button" onclick="tryExample(0)">ËØïËØïËøô‰∏™</button>
                </div>

                <div class="example-card">
                    <div class="example-title">üìù È°πÁõÆËßÑÂàí</div>
                    <div class="example-code">## È°πÁõÆÂºÄÂèëËÆ°Âàí

### Á¨¨‰∏ÄÈò∂ÊÆµ
1. ÈúÄÊ±ÇÂàÜÊûê
2. ÊäÄÊúØÈÄâÂûã
3. Êû∂ÊûÑËÆæËÆ°

### Á¨¨‰∫åÈò∂ÊÆµ
- [ ] ÂâçÁ´ØÂºÄÂèë
- [ ] ÂêéÁ´ØÂºÄÂèë
- [ ] Êï∞ÊçÆÂ∫ìËÆæËÆ°

> **ÈáçË¶ÅÊèêÈÜí**: ËÆ∞ÂæóÊØèÊó•Â§á‰ªΩ‰ª£Á†Å</div>
                    <button class="try-button" onclick="tryExample(1)">ËØïËØïËøô‰∏™</button>
                </div>

                <div class="example-card">
                    <div class="example-title">üí° ‰ºöËÆÆÁ∫™Ë¶Å</div>
                    <div class="example-code">## È°πÁõÆËÆ®ËÆ∫‰ºöËÆÆ

**Êó∂Èó¥**: 2025Âπ¥6Êúà11Êó•  
**ÂèÇ‰∏é‰∫∫**: Âº†‰∏â„ÄÅÊùéÂõõ„ÄÅÁéã‰∫î

### ËÆ®ËÆ∫Ë¶ÅÁÇπ
1. **ÂäüËÉΩ‰ºòÂåñ**
   - [ ] ÊèêÂçáÁî®Êà∑‰ΩìÈ™å
   - [x] ‰øÆÂ§çÂ∑≤Áü•bug
   
2. **‰∏ãÈò∂ÊÆµËÆ°Âàí**
   - Â¢ûÂä†Êñ∞ÂäüËÉΩ
   - ÊÄßËÉΩ‰ºòÂåñ

---
*‰∏ãÊ¨°‰ºöËÆÆ: ‰∏ãÂë®‰∏â*</div>
                    <button class="try-button" onclick="tryExample(2)">ËØïËØïËøô‰∏™</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let isSourceMode = false;
        
        // Êí§ÈîÄ/ÈáçÂÅöÂéÜÂè≤ËÆ∞ÂΩï
        let history = [];
        let historyIndex = -1;
        let isUndoRedo = false;
        
        const examples = [
            `# ‰ªäÊó•‰ªªÂä°

- [ ] ÂõûÂ§çÈáçË¶ÅÈÇÆ‰ª∂
- [x] ÂÆåÊàêÈ°πÁõÆÊä•Âëä
- [ ] ÂáÜÂ§áÊòéÂ§©ÁöÑ‰ºöËÆÆ
- [x] Êõ¥Êñ∞ÊñáÊ°£

**ËøõÂ∫¶**: 50% ÂÆåÊàê`,

            `## È°πÁõÆÂºÄÂèëËÆ°Âàí

### Á¨¨‰∏ÄÈò∂ÊÆµ
1. ÈúÄÊ±ÇÂàÜÊûê
2. ÊäÄÊúØÈÄâÂûã
3. Êû∂ÊûÑËÆæËÆ°

### Á¨¨‰∫åÈò∂ÊÆµ
- [ ] ÂâçÁ´ØÂºÄÂèë
- [ ] ÂêéÁ´ØÂºÄÂèë
- [ ] Êï∞ÊçÆÂ∫ìËÆæËÆ°

> **ÈáçË¶ÅÊèêÈÜí**: ËÆ∞ÂæóÊØèÊó•Â§á‰ªΩ‰ª£Á†Å`,

            `## È°πÁõÆËÆ®ËÆ∫‰ºöËÆÆ

**Êó∂Èó¥**: 2025Âπ¥6Êúà11Êó•  
**ÂèÇ‰∏é‰∫∫**: Âº†‰∏â„ÄÅÊùéÂõõ„ÄÅÁéã‰∫î

### ËÆ®ËÆ∫Ë¶ÅÁÇπ
1. **ÂäüËÉΩ‰ºòÂåñ**
   - [ ] ÊèêÂçáÁî®Êà∑‰ΩìÈ™å
   - [x] ‰øÆÂ§çÂ∑≤Áü•bug
   
2. **‰∏ãÈò∂ÊÆµËÆ°Âàí**
   - Â¢ûÂä†Êñ∞ÂäüËÉΩ
   - ÊÄßËÉΩ‰ºòÂåñ

---
*‰∏ãÊ¨°‰ºöËÆÆ: ‰∏ãÂë®‰∏â*`
        ];

        // ÂàáÊç¢ÁºñËæëÊ®°Âºè
        function toggleMode() {
            const wysiwygEditor = document.getElementById('wysiwygEditor');
            const sourceEditor = document.getElementById('sourceEditor');
            const toggleBtn = document.querySelector('.mode-toggle');
            
            if (isSourceMode) {
                // ÂàáÊç¢Âà∞WYSIWYGÊ®°Âºè
                const markdownText = sourceEditor.value;
                wysiwygEditor.innerHTML = renderMarkdownToHtml(markdownText);
                wysiwygEditor.style.display = 'block';
                sourceEditor.style.display = 'none';
                toggleBtn.textContent = 'Ê∫êÁ†Å';
                isSourceMode = false;
            } else {
                // ÂàáÊç¢Âà∞Ê∫êÁ†ÅÊ®°Âºè
                const htmlContent = wysiwygEditor.innerHTML;
                sourceEditor.value = htmlToMarkdown(htmlContent);
                wysiwygEditor.style.display = 'none';
                sourceEditor.style.display = 'block';
                toggleBtn.textContent = 'È¢ÑËßà';
                isSourceMode = true;
            }
        }

        // ÊèíÂÖ•Ê†ºÂºèÂåñÊñáÊú¨
        function insertFormatting(before, after, placeholder) {
            if (isSourceMode) {
                insertIntoTextarea(before, after, placeholder);
            } else {
                insertIntoContentEditable(before, after, placeholder);
            }
        }

        // ÊèíÂÖ•Ê†áÈ¢ò
        function insertHeading(level) {
            const prefix = '#'.repeat(level) + ' ';
            if (isSourceMode) {
                insertIntoTextarea(prefix, '', 'Ê†áÈ¢òÊñáÂ≠ó');
            } else {
                insertIntoContentEditable(prefix, '', 'Ê†áÈ¢òÊñáÂ≠ó');
            }
        }

        // ÊèíÂÖ•ÂæÖÂäû‰∫ãÈ°π
        function insertTodo(completed) {
            const prefix = completed ? '- [x] ' : '- [ ] ';
            if (isSourceMode) {
                insertIntoTextarea(prefix, '', 'ÂæÖÂäû‰∫ãÈ°π');
            } else {
                insertTodoIntoEditor(completed);
            }
        }

        // ÊèíÂÖ•ÂàóË°®
        function insertList(ordered) {
            const prefix = ordered ? '1. ' : '- ';
            if (isSourceMode) {
                insertIntoTextarea(prefix, '', 'ÂàóË°®È°π');
            } else {
                insertIntoContentEditable(prefix, '', 'ÂàóË°®È°π');
            }
        }

        // ÊèíÂÖ•ÂºïÁî®
        function insertQuote() {
            if (isSourceMode) {
                insertIntoTextarea('> ', '', 'ÂºïÁî®ÊñáÂ≠ó');
            } else {
                insertIntoContentEditable('> ', '', 'ÂºïÁî®ÊñáÂ≠ó');
            }
        }

        // ÊèíÂÖ•ÂàÜÈöîÁ∫ø
        function insertDivider() {
            if (isSourceMode) {
                insertIntoTextarea('\n---\n', '', '');
            } else {
                insertIntoContentEditable('\n---\n', '', '');
            }
        }

        // Âú®ÊñáÊú¨Âå∫ÂüüÊèíÂÖ•ÊñáÊú¨
        function insertIntoTextarea(before, after, placeholder) {
            const textarea = document.getElementById('sourceEditor');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);
            
            // ÁâπÊÆäÂ§ÑÁêÜÂæÖÂäû‰∫ãÈ°π - Ê£ÄÊü•ÊòØÂê¶Âú®Ë°åÈ¶ñÂπ∂ËΩ¨Êç¢ÂΩìÂâçË°å
            if (before.includes('- [') && !selectedText) {
                const lines = textarea.value.split('\n');
                let currentLineIndex = 0;
                let charCount = 0;
                
                // ÊâæÂà∞ÂÖâÊ†áÊâÄÂú®ÁöÑË°å
                for (let i = 0; i < lines.length; i++) {
                    if (charCount + lines[i].length >= start) {
                        currentLineIndex = i;
                        break;
                    }
                    charCount += lines[i].length + 1; // +1 for newline
                }
                
                const currentLine = lines[currentLineIndex].trim();
                
                                 // Â¶ÇÊûúÂΩìÂâçË°åÊúâÂÜÖÂÆπ‰∏î‰∏çÊòØÂ∑≤ÊúâÁöÑÂæÖÂäû‰∫ãÈ°π
                 if (currentLine && !currentLine.match(/^- \[[ x]\]/)) {
                     // Â∞ÜÂΩìÂâçË°åËΩ¨Êç¢‰∏∫ÂæÖÂäû‰∫ãÈ°π (ÈªòËÆ§Êú™ÂÆåÊàêÁä∂ÊÄÅ)
                     lines[currentLineIndex] = '- [ ] ' + currentLine;
                    textarea.value = lines.join('\n');
                    
                                         // ËÆæÁΩÆÂÖâÊ†á‰ΩçÁΩÆÂà∞Ë°åÊú´
                     const newPos = charCount + '- [ ] '.length + currentLine.length;
                    textarea.selectionStart = newPos;
                    textarea.selectionEnd = newPos;
                    textarea.focus();
                    return;
                }
            }
            
            let insertText = selectedText ? before + selectedText + after : before + placeholder + after;
            
            // ÂØπ‰∫éÊñ∞Ë°åÈ°πÁõÆÔºåÁ°Æ‰øùÂú®Êñ∞Ë°åÂºÄÂßã
            if (before.includes('\n') || before.match(/^(#{1,3}\s|[-\d+]\s|\>\s|.*\[[ x]\])/)) {
                const beforeCursor = textarea.value.substring(0, start);
                if (beforeCursor && !beforeCursor.endsWith('\n') && beforeCursor.length > 0) {
                    insertText = '\n' + insertText;
                }
            }
            
            textarea.value = textarea.value.substring(0, start) + insertText + textarea.value.substring(end);
            
            const newPos = start + before.length + (insertText.startsWith('\n') ? 1 : 0);
            textarea.selectionStart = newPos;
            textarea.selectionEnd = newPos + (selectedText || placeholder).length;
            textarea.focus();
        }

        // Âú®ÂèØÁºñËæëÂÜÖÂÆπ‰∏≠ÊèíÂÖ•ÊñáÊú¨
        function insertIntoContentEditable(before, after, placeholder) {
            const editor = document.getElementById('wysiwygEditor');
            editor.focus();
            
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                const selectedText = range.toString();
                
                range.deleteContents();
                
                const textNode = document.createTextNode(before + (selectedText || placeholder) + after);
                range.insertNode(textNode);
                
                // ËÆæÁΩÆÊñ∞ÁöÑÈÄâÊã©ËåÉÂõ¥
                const newRange = document.createRange();
                newRange.setStart(textNode, before.length);
                newRange.setEnd(textNode, before.length + (selectedText || placeholder).length);
                
                selection.removeAllRanges();
                selection.addRange(newRange);
            }
        }

        // Âú®ÁºñËæëÂô®‰∏≠ÊèíÂÖ•ÂæÖÂäû‰∫ãÈ°π
        function insertTodoIntoEditor(completed) {
            const editor = document.getElementById('wysiwygEditor');
            editor.focus();
            
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                
                // Êü•ÊâæÂΩìÂâçË°åÁöÑÊñáÊú¨ÂÜÖÂÆπ
                let currentElement = range.startContainer;
                if (currentElement.nodeType === Node.TEXT_NODE) {
                    currentElement = currentElement.parentElement;
                }
                
                // Ê£ÄÊü•ÊòØÂê¶Âú®ÊÆµËêΩÊàñÂàóË°®È°π‰∏≠
                let lineElement = currentElement;
                while (lineElement && lineElement !== editor && 
                       !['P', 'LI', 'H1', 'H2', 'H3', 'DIV'].includes(lineElement.tagName)) {
                    lineElement = lineElement.parentElement;
                }
                
                if (lineElement && lineElement !== editor) {
                    // Ëé∑ÂèñÂΩìÂâçË°åÁöÑÊñáÊú¨ÂÜÖÂÆπ
                    const currentText = lineElement.textContent.trim();
                    
                                         if (currentText && currentText.length > 0) {
                         // Â¶ÇÊûúÂΩìÂâçË°åÊúâÂÜÖÂÆπÔºåÂ∞ÜÂÖ∂ËΩ¨Êç¢‰∏∫ÂæÖÂäû‰∫ãÈ°π (ÈªòËÆ§Êú™ÂÆåÊàêÁä∂ÊÄÅ)
                         const todoHtml = `
                             <li class="todo-item">
                                 <input type="checkbox" class="todo-checkbox"> 
                                 <span>${currentText}</span>
                             </li>
                         `;
                        
                        // Â¶ÇÊûúÁà∂ÂÖÉÁ¥†‰∏çÊòØulÔºåÈúÄË¶ÅÂàõÂª∫ulÂåÖË£Ö
                        if (lineElement.parentElement.tagName !== 'UL' || 
                            !lineElement.parentElement.classList.contains('todo-list')) {
                            const ul = document.createElement('ul');
                            ul.className = 'todo-list';
                            ul.innerHTML = todoHtml;
                            lineElement.parentElement.replaceChild(ul, lineElement);
                        } else {
                            // Â¶ÇÊûúÂ∑≤ÁªèÂú®todo-list‰∏≠ÔºåÁõ¥Êé•ÊõøÊç¢
                            lineElement.outerHTML = todoHtml;
                        }
                        return;
                    }
                }
            }
            
            // Â¶ÇÊûúÊ≤°ÊúâÊâæÂà∞ÂêàÈÄÇÁöÑË°åÊàñË°å‰∏∫Á©∫ÔºåÊèíÂÖ•Êñ∞ÁöÑÂæÖÂäû‰∫ãÈ°π
            const todoHtml = `
                <ul class="todo-list">
                    <li class="todo-item">
                        <input type="checkbox" class="todo-checkbox" ${completed ? 'checked' : ''}> 
                        <span ${completed ? 'class="todo-completed"' : ''}>ÂæÖÂäû‰∫ãÈ°π</span>
                    </li>
                </ul>
            `;
            
            document.execCommand('insertHTML', false, todoHtml);
        }

        // ËØïÁî®Á§∫‰æã
        function tryExample(index) {
            if (isSourceMode) {
                document.getElementById('sourceEditor').value = examples[index];
            } else {
                document.getElementById('wysiwygEditor').innerHTML = renderMarkdownToHtml(examples[index]);
            }
        }

        // Â∞ÜMarkdownËΩ¨Êç¢‰∏∫HTML
        function renderMarkdownToHtml(markdown) {
            if (!markdown.trim()) return '';
            
            let html = markdown
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                
                // Â§ÑÁêÜÊ†áÈ¢ò
                .replace(/^### (.+)$/gm, '<h3>$1</h3>')
                .replace(/^## (.+)$/gm, '<h2>$1</h2>')
                .replace(/^# (.+)$/gm, '<h1>$1</h1>')
                
                // Â§ÑÁêÜÂàÜÈöîÁ∫ø
                .replace(/^---$/gm, '<hr>')
                
                // Â§ÑÁêÜÂºïÁî®
                .replace(/^> (.+)$/gm, '<blockquote>$1</blockquote>')
                
                // Â§ÑÁêÜÂæÖÂäû‰∫ãÈ°π
                .replace(/^- \[ \] (.+)$/gm, '<li class="todo-item"><input type="checkbox" class="todo-checkbox"> <span>$1</span></li>')
                .replace(/^- \[x\] (.+)$/gm, '<li class="todo-item"><input type="checkbox" class="todo-checkbox" checked> <span class="todo-completed">$1</span></li>')
                
                // Â§ÑÁêÜÊôÆÈÄöÂàóË°®
                .replace(/^- (.+)$/gm, '<li>$1</li>')
                .replace(/^(\d+)\. (.+)$/gm, '<li>$2</li>')
                
                // Â§ÑÁêÜË°åÂÜÖ‰ª£Á†Å
                .replace(/`([^`]+)`/g, '<code>$1</code>')
                
                // Â§ÑÁêÜÁ≤ó‰Ωì
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                
                // Â§ÑÁêÜÊñú‰Ωì
                .replace(/\*(.+?)\*/g, '<em>$1</em>')
                
                // Â§ÑÁêÜÊÆµËêΩ
                .split('\n\n').map(paragraph => {
                    if (paragraph.includes('<h1>') || paragraph.includes('<h2>') || paragraph.includes('<h3>') ||
                        paragraph.includes('<li>') || paragraph.includes('<blockquote>') || 
                        paragraph.includes('<hr>')) {
                        return paragraph;
                    }
                    return paragraph.trim() ? `<p>${paragraph.replace(/\n/g, '<br>')}</p>` : '';
                }).join('\n');
            
            // ÂåÖË£ÖÂàóË°®
            html = html.replace(/(<li(?:[^>]*)>.*?<\/li>)(\s*<li(?:[^>]*)>.*?<\/li>)*/gs, function(match) {
                if (match.includes('todo-item')) {
                    return '<ul class="todo-list">' + match.replace(/\s*(?=<li)/g, '') + '</ul>';
                } else {
                    return '<ul>' + match.replace(/\s*(?=<li)/g, '') + '</ul>';
                }
            });
            
            return html;
        }

        // Â∞ÜHTMLËΩ¨Êç¢‰∏∫Markdown
        function htmlToMarkdown(html) {
            // ÂàõÂª∫‰∏¥Êó∂ÂÖÉÁ¥†
            const temp = document.createElement('div');
            temp.innerHTML = html;
            
            let markdown = '';
            
            function processNode(node) {
                if (node.nodeType === Node.TEXT_NODE) {
                    return node.textContent;
                }
                
                if (node.nodeType === Node.ELEMENT_NODE) {
                    switch (node.tagName.toLowerCase()) {
                        case 'h1':
                            return '# ' + node.textContent + '\n\n';
                        case 'h2':
                            return '## ' + node.textContent + '\n\n';
                        case 'h3':
                            return '### ' + node.textContent + '\n\n';
                        case 'p':
                            return node.textContent + '\n\n';
                        case 'strong':
                            return '**' + node.textContent + '**';
                        case 'em':
                            return '*' + node.textContent + '*';
                        case 'code':
                            return '`' + node.textContent + '`';
                        case 'blockquote':
                            return '> ' + node.textContent + '\n\n';
                        case 'hr':
                            return '---\n\n';
                        case 'ul':
                            let result = '';
                            for (let child of node.children) {
                                if (child.classList.contains('todo-item')) {
                                    const checkbox = child.querySelector('input[type="checkbox"]');
                                    const checked = checkbox && checkbox.checked;
                                    const text = child.querySelector('span').textContent;
                                    result += (checked ? '- [x] ' : '- [ ] ') + text + '\n';
                                } else {
                                    result += '- ' + child.textContent + '\n';
                                }
                            }
                            return result + '\n';
                        case 'ol':
                            let olResult = '';
                            let index = 1;
                            for (let child of node.children) {
                                olResult += index + '. ' + child.textContent + '\n';
                                index++;
                            }
                            return olResult + '\n';
                        default:
                            let content = '';
                            for (let child of node.childNodes) {
                                content += processNode(child);
                            }
                            return content;
                    }
                }
                return '';
            }
            
            for (let child of temp.childNodes) {
                markdown += processNode(child);
            }
            
            return markdown.trim();
        }

        // Â§ÑÁêÜÂæÖÂäû‰∫ãÈ°πÁÇπÂáª
        document.addEventListener('change', function(e) {
            if (e.target.classList.contains('todo-checkbox') && !isSourceMode) {
                const span = e.target.nextElementSibling;
                if (e.target.checked) {
                    span.classList.add('todo-completed');
                } else {
                    span.classList.remove('todo-completed');
                }
            }
        });

        // Êí§ÈîÄÂäüËÉΩ
        function undo() {
            if (historyIndex > 0) {
                historyIndex--;
                isUndoRedo = true;
                
                if (isSourceMode) {
                    document.getElementById('sourceEditor').value = history[historyIndex];
                } else {
                    document.getElementById('wysiwygEditor').innerHTML = history[historyIndex];
                }
                
                setTimeout(() => { isUndoRedo = false; }, 100);
            }
        }

        // ÈáçÂÅöÂäüËÉΩ
        function redo() {
            if (historyIndex < history.length - 1) {
                historyIndex++;
                isUndoRedo = true;
                
                if (isSourceMode) {
                    document.getElementById('sourceEditor').value = history[historyIndex];
                } else {
                    document.getElementById('wysiwygEditor').innerHTML = history[historyIndex];
                }
                
                setTimeout(() => { isUndoRedo = false; }, 100);
            }
        }

        // ‰øùÂ≠òÂéÜÂè≤Áä∂ÊÄÅ
        function saveHistory() {
            if (isUndoRedo) return;
            
            const content = isSourceMode ? 
                document.getElementById('sourceEditor').value : 
                document.getElementById('wysiwygEditor').innerHTML;
            
            // Â¶ÇÊûúÂÜÖÂÆπ‰∏é‰∏äÊ¨°Áõ∏ÂêåÔºå‰∏ç‰øùÂ≠ò
            if (history[historyIndex] === content) return;
            
            // Ê∏ÖÈô§ÂΩìÂâç‰ΩçÁΩÆ‰πãÂêéÁöÑÂéÜÂè≤
            history = history.slice(0, historyIndex + 1);
            
            // Ê∑ªÂä†Êñ∞Áä∂ÊÄÅ
            history.push(content);
            historyIndex++;
            
            // ÈôêÂà∂ÂéÜÂè≤ËÆ∞ÂΩïÊï∞Èáè
            if (history.length > 50) {
                history.shift();
                historyIndex--;
            }
        }

        // ÂàùÂßãÂåñÂéÜÂè≤ËÆ∞ÂΩï
        function initHistory() {
            const initialContent = document.getElementById('wysiwygEditor').innerHTML;
            history.push(initialContent);
            historyIndex = 0;
        }

        // È°µÈù¢Âä†ËΩΩÊó∂ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            initHistory();
            
            // ÁõëÂê¨ÂÜÖÂÆπÂèòÂåñ
            const wysiwygEditor = document.getElementById('wysiwygEditor');
            const sourceEditor = document.getElementById('sourceEditor');
            
            let saveTimeout;
            
            wysiwygEditor.addEventListener('input', function() {
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(saveHistory, 500);
            });
            
            sourceEditor.addEventListener('input', function() {
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(saveHistory, 500);
            });
        });

        // ÂÖ®Â±ÄÈîÆÁõòÂø´Êç∑ÈîÆ
        document.addEventListener('keydown', function(e) {
            // Ctrl+Z Êí§ÈîÄ
            if (e.ctrlKey && e.key === 'z' && !e.shiftKey) {
                e.preventDefault();
                undo();
            }
            // Ctrl+Y Êàñ Ctrl+Shift+Z ÈáçÂÅö
            else if ((e.ctrlKey && e.key === 'y') || (e.ctrlKey && e.shiftKey && e.key === 'Z')) {
                e.preventDefault();
                redo();
            }
            // Ctrl+A ÂÖ®ÈÄâ
            else if (e.ctrlKey && e.key === 'a') {
                if (isSourceMode) {
                    // Ê∫êÁ†ÅÊ®°Âºè‰∏ãËÆ©ÈªòËÆ§Ë°å‰∏∫Â§ÑÁêÜ
                    return;
                } else {
                    // WYSIWYGÊ®°Âºè‰∏ãÂÖ®ÈÄâ
                    e.preventDefault();
                    const selection = window.getSelection();
                    const range = document.createRange();
                    range.selectNodeContents(document.getElementById('wysiwygEditor'));
                    selection.removeAllRanges();
                    selection.addRange(range);
                }
            }
            // Ctrl+S ‰øùÂ≠òÔºàËøôÈáåÂèØ‰ª•Êâ©Â±ï‰∏∫ÂÆûÈôÖ‰øùÂ≠òÂäüËÉΩÔºâ
            else if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                alert('‰øùÂ≠òÂäüËÉΩÂèØ‰ª•Âú®ËøôÈáåÂÆûÁé∞ÔºÅ');
            }
        });

        // ÊîπËøõTabÈîÆÂíåÁº©ËøõÂ§ÑÁêÜ
        document.getElementById('sourceEditor').addEventListener('keydown', function(e) {
            if (e.key === 'Tab') {
                e.preventDefault();
                const start = this.selectionStart;
                const end = this.selectionEnd;
                
                if (e.shiftKey) {
                    // Shift+Tab ÂáèÂ∞ëÁº©Ëøõ
                    const lines = this.value.split('\n');
                    let startLine = 0;
                    let endLine = 0;
                    let currentPos = 0;
                    
                    // ÊâæÂà∞ÈÄâ‰∏≠Âå∫ÂüüÁöÑË°å
                    for (let i = 0; i < lines.length; i++) {
                        if (currentPos <= start && currentPos + lines[i].length >= start) {
                            startLine = i;
                        }
                        if (currentPos <= end && currentPos + lines[i].length >= end) {
                            endLine = i;
                            break;
                        }
                        currentPos += lines[i].length + 1;
                    }
                    
                    // ÂáèÂ∞ëÁº©Ëøõ
                    for (let i = startLine; i <= endLine; i++) {
                        if (lines[i].startsWith('    ')) {
                            lines[i] = lines[i].substring(4);
                        } else if (lines[i].startsWith('\t')) {
                            lines[i] = lines[i].substring(1);
                        }
                    }
                    
                    this.value = lines.join('\n');
                } else {
                    // Tab Â¢ûÂä†Áº©Ëøõ
                    if (start === end) {
                        // Ê≤°ÊúâÈÄâ‰∏≠ÊñáÊú¨ÔºåÊèíÂÖ•4‰∏™Á©∫Ê†º
                        this.value = this.value.substring(0, start) + '    ' + this.value.substring(end);
                        this.selectionStart = this.selectionEnd = start + 4;
                    } else {
                        // ÊúâÈÄâ‰∏≠ÊñáÊú¨ÔºåÂØπÈÄâ‰∏≠ÁöÑÊØèË°åÂ¢ûÂä†Áº©Ëøõ
                        const lines = this.value.split('\n');
                        let startLine = 0;
                        let endLine = 0;
                        let currentPos = 0;
                        
                        // ÊâæÂà∞ÈÄâ‰∏≠Âå∫ÂüüÁöÑË°å
                        for (let i = 0; i < lines.length; i++) {
                            if (currentPos <= start && currentPos + lines[i].length >= start) {
                                startLine = i;
                            }
                            if (currentPos <= end && currentPos + lines[i].length >= end) {
                                endLine = i;
                                break;
                            }
                            currentPos += lines[i].length + 1;
                        }
                        
                        // Â¢ûÂä†Áº©Ëøõ
                        for (let i = startLine; i <= endLine; i++) {
                            lines[i] = '    ' + lines[i];
                        }
                        
                        this.value = lines.join('\n');
                        this.selectionStart = start + 4;
                        this.selectionEnd = end + 4 * (endLine - startLine + 1);
                    }
                }
                
                // Ëß¶ÂèëËæìÂÖ•‰∫ã‰ª∂‰ª•‰øùÂ≠òÂéÜÂè≤
                this.dispatchEvent(new Event('input'));
            }
            // EnterÈîÆËá™Âä®Áº©Ëøõ
            else if (e.key === 'Enter') {
                const start = this.selectionStart;
                const lines = this.value.substring(0, start).split('\n');
                const currentLine = lines[lines.length - 1];
                
                // Ê£ÄÊµãÂΩìÂâçË°åÁöÑÁº©Ëøõ
                const indentMatch = currentLine.match(/^(\s*)/);
                if (indentMatch) {
                    const indent = indentMatch[1];
                    
                    // Â¶ÇÊûúÂΩìÂâçË°åÊòØÂàóË°®È°πÔºåÊ£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅËá™Âä®ÁªßÁª≠ÂàóË°®
                    const listMatch = currentLine.match(/^(\s*)([-*+]|\d+\.)\s/);
                    if (listMatch) {
                        const listIndent = listMatch[1];
                        const listMarker = listMatch[2];
                        
                        setTimeout(() => {
                            const currentPos = this.selectionStart;
                            let newMarker = listMarker;
                            
                            // Â¶ÇÊûúÊòØÊï∞Â≠óÂàóË°®ÔºåÈÄíÂ¢ûÊï∞Â≠ó
                            if (/\d+\./.test(listMarker)) {
                                const num = parseInt(listMarker) + 1;
                                newMarker = num + '.';
                            }
                            
                            const newListItem = listIndent + newMarker + ' ';
                            this.value = this.value.substring(0, currentPos) + newListItem + this.value.substring(currentPos);
                            this.selectionStart = this.selectionEnd = currentPos + newListItem.length;
                            
                            this.dispatchEvent(new Event('input'));
                        }, 0);
                    } else if (indent) {
                        // ÊôÆÈÄöÁº©ËøõÂª∂Áª≠
                        setTimeout(() => {
                            const currentPos = this.selectionStart;
                            this.value = this.value.substring(0, currentPos) + indent + this.value.substring(currentPos);
                            this.selectionStart = this.selectionEnd = currentPos + indent.length;
                            
                            this.dispatchEvent(new Event('input'));
                        }, 0);
                    }
                }
            }
        });
    </script>
</body>
</html> 