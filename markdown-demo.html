<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Typoraé£æ ¼ç¼–è¾‘å™¨ Demo - DAY</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #f0f7ff 0%, #e3f2fd 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .demo-container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .demo-header {
            background: linear-gradient(135deg, #7BB3F0, #5A9BD4);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .demo-title {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .demo-subtitle {
            opacity: 0.9;
            font-size: 16px;
        }

        .demo-content {
            padding: 30px;
        }

        /* Typoraé£æ ¼ç¼–è¾‘å™¨ */
        .typora-editor {
            border: 2px solid #e0e7ff;
            border-radius: 12px;
            overflow: hidden;
            background: white;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }

        .typora-toolbar {
            display: flex;
            gap: 8px;
            padding: 12px 16px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            flex-wrap: wrap;
            align-items: center;
        }

        .toolbar-group {
            display: flex;
            gap: 4px;
            padding-right: 12px;
            border-right: 1px solid #e2e8f0;
        }

        .toolbar-group:last-child {
            border-right: none;
        }

        .typora-toolbar button {
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            min-width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .typora-toolbar button:hover {
            background: #f1f5f9;
            border-color: #7BB3F0;
            color: #5A9BD4;
            transform: translateY(-1px);
        }

        .mode-toggle {
            margin-left: auto;
            background: #7BB3F0 !important;
            color: white !important;
            border-color: #7BB3F0 !important;
        }

        .mode-toggle:hover {
            background: #5A9BD4 !important;
        }

        /* ç¼–è¾‘å™¨å®¹å™¨ */
        .editor-area {
            position: relative;
            min-height: 500px;
            max-height: 600px;
            overflow-y: auto;
        }

        /* å®æ—¶ç¼–è¾‘å™¨ (Typoraé£æ ¼) */
        .wysiwyg-editor {
            width: 100%;
            min-height: 500px;
            padding: 24px;
            border: none;
            outline: none;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-size: 16px;
            line-height: 1.7;
            color: #374151;
            resize: none;
            background: transparent;
        }

        /* æºç ç¼–è¾‘å™¨ */
        .source-editor {
            width: 100%;
            min-height: 500px;
            padding: 24px;
            border: none;
            outline: none;
            font-family: 'JetBrains Mono', 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 14px;
            line-height: 1.6;
            color: #374151;
            resize: none;
            background: #fafbfc;
            display: none;
            tab-size: 4;
            white-space: pre;
            word-wrap: break-word;
        }

        /* Markdownæ¸²æŸ“æ ·å¼ */
        .wysiwyg-editor h1 {
            font-size: 32px;
            font-weight: 700;
            color: #1e293b;
            margin: 24px 0 16px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid #e2e8f0;
        }

        .wysiwyg-editor h2 {
            font-size: 24px;
            font-weight: 600;
            color: #1e293b;
            margin: 20px 0 12px 0;
        }

        .wysiwyg-editor h3 {
            font-size: 20px;
            font-weight: 600;
            color: #1e293b;
            margin: 16px 0 8px 0;
        }

        .wysiwyg-editor p {
            margin-bottom: 16px;
            color: #374151;
        }

        .wysiwyg-editor ul, .wysiwyg-editor ol {
            margin: 16px 0;
            padding-left: 24px;
        }

        .wysiwyg-editor li {
            margin-bottom: 8px;
            color: #374151;
        }

        .wysiwyg-editor .todo-list {
            list-style: none;
            padding-left: 0;
        }

        .wysiwyg-editor .todo-item {
            display: flex;
            align-items: center;
            padding: 6px 0;
            margin-bottom: 4px;
            position: relative;
        }

        .wysiwyg-editor .todo-checkbox {
            margin-right: 8px;
            margin-top: 0;
            transform: scale(1.2);
            cursor: pointer;
            flex-shrink: 0;
        }

        .wysiwyg-editor .todo-completed {
            text-decoration: line-through;
            color: #9ca3af;
        }

        .wysiwyg-editor strong {
            font-weight: 600;
            color: #1e293b;
        }

        .wysiwyg-editor em {
            font-style: italic;
            color: #7BB3F0;
        }

        .wysiwyg-editor code {
            background: #f1f5f9;
            color: #e11d48;
            padding: 3px 6px;
            border-radius: 4px;
            font-family: 'JetBrains Mono', 'Monaco', monospace;
            font-size: 14px;
        }

        .wysiwyg-editor blockquote {
            border-left: 4px solid #7BB3F0;
            padding-left: 16px;
            margin: 16px 0;
            color: #64748b;
            font-style: italic;
            background: #f8fafc;
            padding: 12px 16px;
            border-radius: 0 6px 6px 0;
        }

        .wysiwyg-editor hr {
            border: none;
            border-top: 2px solid #e2e8f0;
            margin: 24px 0;
        }

        /* éšè—çš„markdownè¯­æ³• */
        .wysiwyg-editor .md-syntax {
            color: #9ca3af;
            font-size: 0.9em;
            user-select: none;
        }

        /* ç¤ºä¾‹åŒºåŸŸ */
        .examples {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .example-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
        }

        .example-title {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 8px;
        }

        .example-code {
            background: #1e293b;
            color: #e2e8f0;
            padding: 12px;
            border-radius: 6px;
            font-family: 'JetBrains Mono', 'Monaco', monospace;
            font-size: 12px;
            line-height: 1.5;
            white-space: pre-wrap;
            margin-bottom: 12px;
        }

        .try-button {
            background: #7BB3F0;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
        }

        .try-button:hover {
            background: #5A9BD4;
        }

        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .examples {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="demo-container">
        <div class="demo-header">
            <h1 class="demo-title">ğŸ“ Typoraé£æ ¼ç¼–è¾‘å™¨</h1>
            <p class="demo-subtitle">æ‰€è§å³æ‰€å¾—çš„Markdownç¼–è¾‘ä½“éªŒ</p>
        </div>
        
        <div class="demo-content">
            <!-- Typoraé£æ ¼ç¼–è¾‘å™¨ -->
            <div class="typora-editor">
                <div class="typora-toolbar">
                    <div class="toolbar-group">
                        <button onclick="undo()" title="æ’¤é”€ (Ctrl+Z)">â†¶</button>
                        <button onclick="redo()" title="é‡åš (Ctrl+Y)">â†·</button>
                    </div>
                    <div class="toolbar-group">
                        <button onclick="insertFormatting('**', '**', 'ç²—ä½“æ–‡å­—')" title="ç²—ä½“">ğ</button>
                        <button onclick="insertFormatting('*', '*', 'æ–œä½“æ–‡å­—')" title="æ–œä½“">ğ¼</button>
                        <button onclick="insertFormatting('`', '`', 'ä»£ç ')" title="è¡Œå†…ä»£ç ">â€¹/â€º</button>
                    </div>
                    <div class="toolbar-group">
                        <button onclick="insertHeading(1)" title="ä¸€çº§æ ‡é¢˜">H1</button>
                        <button onclick="insertHeading(2)" title="äºŒçº§æ ‡é¢˜">H2</button>
                        <button onclick="insertHeading(3)" title="ä¸‰çº§æ ‡é¢˜">H3</button>
                    </div>
                    <div class="toolbar-group">
                        <button onclick="insertTodo(false)" title="å¾…åŠäº‹é¡¹">â˜</button>
                        <button onclick="insertTodo(true)" title="å·²å®Œæˆ">â˜‘</button>
                        <button onclick="insertList(false)" title="æ— åºåˆ—è¡¨">â€¢</button>
                        <button onclick="insertList(true)" title="æœ‰åºåˆ—è¡¨">1.</button>
                    </div>
                    <div class="toolbar-group">
                        <button onclick="insertQuote()" title="å¼•ç”¨">â</button>
                        <button onclick="insertDivider()" title="åˆ†éš”çº¿">â€•</button>
                    </div>
                    <button class="mode-toggle" onclick="toggleMode()" title="åˆ‡æ¢ç¼–è¾‘æ¨¡å¼">æºç </button>
                </div>
                
                <div class="editor-area">
                    <div id="wysiwygEditor" class="wysiwyg-editor" contenteditable="true" placeholder="å¼€å§‹è¾“å…¥æ‚¨çš„å†…å®¹...">
                        <h1>æ¬¢è¿ä½¿ç”¨ Typoraé£æ ¼ç¼–è¾‘å™¨</h1>
                        <p>è¿™æ˜¯ä¸€ä¸ªæ‰€è§å³æ‰€å¾—çš„Markdownç¼–è¾‘å™¨ï¼Œä½“éªŒå°±åƒ Typora ä¸€æ ·ï¼</p>
                        
                        <h2>åŠŸèƒ½ç‰¹è‰²</h2>
                        <ul>
                            <li><strong>å®æ—¶é¢„è§ˆ</strong>ï¼šè¾¹å†™è¾¹çœ‹æ•ˆæœ</li>
                            <li><em>ç®€æ´ç•Œé¢</em>ï¼šä¸“æ³¨äºå†…å®¹åˆ›ä½œ</li>
                            <li><code>è¯­æ³•é«˜äº®</code>ï¼šä»£ç æ˜¾ç¤ºæ¸…æ™°</li>
                        </ul>
                        
                        <h3>è¯•è¯•å¾…åŠåˆ—è¡¨</h3>
                        <ul class="todo-list">
                            <li class="todo-item">
                                <input type="checkbox" class="todo-checkbox"> 
                                <span>å†™ä¸€ç¯‡åšå®¢æ–‡ç« </span>
                            </li>
                            <li class="todo-item">
                                <input type="checkbox" class="todo-checkbox" checked> 
                                <span class="todo-completed">å®Œæˆé¡¹ç›®æ–‡æ¡£</span>
                            </li>
                        </ul>
                        
                        <blockquote>
                            ğŸ’¡ æç¤ºï¼šç‚¹å‡»å·¥å…·æ æŒ‰é’®å¿«é€Ÿæ’å…¥æ ¼å¼ï¼Œæˆ–ç›´æ¥è¾“å…¥Markdownè¯­æ³•ï¼
                        </blockquote>
                    </div>
                    
                    <textarea id="sourceEditor" class="source-editor"></textarea>
                </div>
            </div>

            <!-- ç¤ºä¾‹åŒºåŸŸ -->
            <h2 style="margin-bottom: 16px; color: #1e293b;">ğŸ“š å¿«é€Ÿç¤ºä¾‹</h2>
            <div class="examples">
                <div class="example-card">
                    <div class="example-title">ğŸ“‹ ä»»åŠ¡åˆ—è¡¨</div>
                    <div class="example-code"># ä»Šæ—¥ä»»åŠ¡

- [ ] å›å¤é‡è¦é‚®ä»¶
- [x] å®Œæˆé¡¹ç›®æŠ¥å‘Š
- [ ] å‡†å¤‡æ˜å¤©çš„ä¼šè®®
- [x] æ›´æ–°æ–‡æ¡£

**è¿›åº¦**: 50% å®Œæˆ</div>
                    <button class="try-button" onclick="tryExample(0)">è¯•è¯•è¿™ä¸ª</button>
                </div>

                <div class="example-card">
                    <div class="example-title">ğŸ“ é¡¹ç›®è§„åˆ’</div>
                    <div class="example-code">## é¡¹ç›®å¼€å‘è®¡åˆ’

### ç¬¬ä¸€é˜¶æ®µ
1. éœ€æ±‚åˆ†æ
2. æŠ€æœ¯é€‰å‹
3. æ¶æ„è®¾è®¡

### ç¬¬äºŒé˜¶æ®µ
- [ ] å‰ç«¯å¼€å‘
- [ ] åç«¯å¼€å‘
- [ ] æ•°æ®åº“è®¾è®¡

> **é‡è¦æé†’**: è®°å¾—æ¯æ—¥å¤‡ä»½ä»£ç </div>
                    <button class="try-button" onclick="tryExample(1)">è¯•è¯•è¿™ä¸ª</button>
                </div>

                <div class="example-card">
                    <div class="example-title">ğŸ’¡ ä¼šè®®çºªè¦</div>
                    <div class="example-code">## é¡¹ç›®è®¨è®ºä¼šè®®

**æ—¶é—´**: 2025å¹´6æœˆ11æ—¥  
**å‚ä¸äºº**: å¼ ä¸‰ã€æå››ã€ç‹äº”

### è®¨è®ºè¦ç‚¹
1. **åŠŸèƒ½ä¼˜åŒ–**
   - [ ] æå‡ç”¨æˆ·ä½“éªŒ
   - [x] ä¿®å¤å·²çŸ¥bug
   
2. **ä¸‹é˜¶æ®µè®¡åˆ’**
   - å¢åŠ æ–°åŠŸèƒ½
   - æ€§èƒ½ä¼˜åŒ–

---
*ä¸‹æ¬¡ä¼šè®®: ä¸‹å‘¨ä¸‰*</div>
                    <button class="try-button" onclick="tryExample(2)">è¯•è¯•è¿™ä¸ª</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let isSourceMode = false;
        
        // æ’¤é”€/é‡åšå†å²è®°å½•
        let history = [];
        let historyIndex = -1;
        let isUndoRedo = false;
        
        const examples = [
            `# ä»Šæ—¥ä»»åŠ¡

- [ ] å›å¤é‡è¦é‚®ä»¶
- [x] å®Œæˆé¡¹ç›®æŠ¥å‘Š
- [ ] å‡†å¤‡æ˜å¤©çš„ä¼šè®®
- [x] æ›´æ–°æ–‡æ¡£

**è¿›åº¦**: 50% å®Œæˆ`,

            `## é¡¹ç›®å¼€å‘è®¡åˆ’

### ç¬¬ä¸€é˜¶æ®µ
1. éœ€æ±‚åˆ†æ
2. æŠ€æœ¯é€‰å‹
3. æ¶æ„è®¾è®¡

### ç¬¬äºŒé˜¶æ®µ
- [ ] å‰ç«¯å¼€å‘
- [ ] åç«¯å¼€å‘
- [ ] æ•°æ®åº“è®¾è®¡

> **é‡è¦æé†’**: è®°å¾—æ¯æ—¥å¤‡ä»½ä»£ç `,

            `## é¡¹ç›®è®¨è®ºä¼šè®®

**æ—¶é—´**: 2025å¹´6æœˆ11æ—¥  
**å‚ä¸äºº**: å¼ ä¸‰ã€æå››ã€ç‹äº”

### è®¨è®ºè¦ç‚¹
1. **åŠŸèƒ½ä¼˜åŒ–**
   - [ ] æå‡ç”¨æˆ·ä½“éªŒ
   - [x] ä¿®å¤å·²çŸ¥bug
   
2. **ä¸‹é˜¶æ®µè®¡åˆ’**
   - å¢åŠ æ–°åŠŸèƒ½
   - æ€§èƒ½ä¼˜åŒ–

---
*ä¸‹æ¬¡ä¼šè®®: ä¸‹å‘¨ä¸‰*`
        ];

        // åˆ‡æ¢ç¼–è¾‘æ¨¡å¼
        function toggleMode() {
            const wysiwygEditor = document.getElementById('wysiwygEditor');
            const sourceEditor = document.getElementById('sourceEditor');
            const toggleBtn = document.querySelector('.mode-toggle');
            
            if (isSourceMode) {
                // åˆ‡æ¢åˆ°WYSIWYGæ¨¡å¼
                const markdownText = sourceEditor.value;
                wysiwygEditor.innerHTML = renderMarkdownToHtml(markdownText);
                wysiwygEditor.style.display = 'block';
                sourceEditor.style.display = 'none';
                toggleBtn.textContent = 'æºç ';
                isSourceMode = false;
            } else {
                // åˆ‡æ¢åˆ°æºç æ¨¡å¼
                const htmlContent = wysiwygEditor.innerHTML;
                sourceEditor.value = htmlToMarkdown(htmlContent);
                wysiwygEditor.style.display = 'none';
                sourceEditor.style.display = 'block';
                toggleBtn.textContent = 'é¢„è§ˆ';
                isSourceMode = true;
            }
        }

        // æ’å…¥æ ¼å¼åŒ–æ–‡æœ¬
        function insertFormatting(before, after, placeholder) {
            if (isSourceMode) {
                insertIntoTextarea(before, after, placeholder);
            } else {
                insertIntoContentEditable(before, after, placeholder);
            }
        }

        // æ’å…¥æ ‡é¢˜
        function insertHeading(level) {
            const prefix = '#'.repeat(level) + ' ';
            if (isSourceMode) {
                insertIntoTextarea(prefix, '', 'æ ‡é¢˜æ–‡å­—');
            } else {
                insertIntoContentEditable(prefix, '', 'æ ‡é¢˜æ–‡å­—');
            }
        }

        // æ’å…¥å¾…åŠäº‹é¡¹
        function insertTodo(completed) {
            const prefix = completed ? '- [x] ' : '- [ ] ';
            if (isSourceMode) {
                insertIntoTextarea(prefix, '', 'å¾…åŠäº‹é¡¹');
            } else {
                insertTodoIntoEditor(completed);
            }
        }

        // æ’å…¥åˆ—è¡¨
        function insertList(ordered) {
            const prefix = ordered ? '1. ' : '- ';
            if (isSourceMode) {
                insertIntoTextarea(prefix, '', 'åˆ—è¡¨é¡¹');
            } else {
                insertIntoContentEditable(prefix, '', 'åˆ—è¡¨é¡¹');
            }
        }

        // æ’å…¥å¼•ç”¨
        function insertQuote() {
            if (isSourceMode) {
                insertIntoTextarea('> ', '', 'å¼•ç”¨æ–‡å­—');
            } else {
                insertIntoContentEditable('> ', '', 'å¼•ç”¨æ–‡å­—');
            }
        }

        // æ’å…¥åˆ†éš”çº¿
        function insertDivider() {
            if (isSourceMode) {
                insertIntoTextarea('\n---\n', '', '');
            } else {
                insertIntoContentEditable('\n---\n', '', '');
            }
        }

        // åœ¨æ–‡æœ¬åŒºåŸŸæ’å…¥æ–‡æœ¬
        function insertIntoTextarea(before, after, placeholder) {
            const textarea = document.getElementById('sourceEditor');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);
            
            // ç‰¹æ®Šå¤„ç†å¾…åŠäº‹é¡¹ - æ£€æŸ¥æ˜¯å¦åœ¨è¡Œé¦–å¹¶è½¬æ¢å½“å‰è¡Œ
            if (before.includes('- [') && !selectedText) {
                const lines = textarea.value.split('\n');
                let currentLineIndex = 0;
                let charCount = 0;
                
                // æ‰¾åˆ°å…‰æ ‡æ‰€åœ¨çš„è¡Œ
                for (let i = 0; i < lines.length; i++) {
                    if (charCount + lines[i].length >= start) {
                        currentLineIndex = i;
                        break;
                    }
                    charCount += lines[i].length + 1; // +1 for newline
                }
                
                const currentLine = lines[currentLineIndex].trim();
                
                                 // å¦‚æœå½“å‰è¡Œæœ‰å†…å®¹ä¸”ä¸æ˜¯å·²æœ‰çš„å¾…åŠäº‹é¡¹
                 if (currentLine && !currentLine.match(/^- \[[ x]\]/)) {
                     // å°†å½“å‰è¡Œè½¬æ¢ä¸ºå¾…åŠäº‹é¡¹ (é»˜è®¤æœªå®ŒæˆçŠ¶æ€)
                     lines[currentLineIndex] = '- [ ] ' + currentLine;
                    textarea.value = lines.join('\n');
                    
                                         // è®¾ç½®å…‰æ ‡ä½ç½®åˆ°è¡Œæœ«
                     const newPos = charCount + '- [ ] '.length + currentLine.length;
                    textarea.selectionStart = newPos;
                    textarea.selectionEnd = newPos;
                    textarea.focus();
                    return;
                }
            }
            
            let insertText = selectedText ? before + selectedText + after : before + placeholder + after;
            
            // å¯¹äºæ–°è¡Œé¡¹ç›®ï¼Œç¡®ä¿åœ¨æ–°è¡Œå¼€å§‹
            if (before.includes('\n') || before.match(/^(#{1,3}\s|[-\d+]\s|\>\s|.*\[[ x]\])/)) {
                const beforeCursor = textarea.value.substring(0, start);
                if (beforeCursor && !beforeCursor.endsWith('\n') && beforeCursor.length > 0) {
                    insertText = '\n' + insertText;
                }
            }
            
            textarea.value = textarea.value.substring(0, start) + insertText + textarea.value.substring(end);
            
            const newPos = start + before.length + (insertText.startsWith('\n') ? 1 : 0);
            textarea.selectionStart = newPos;
            textarea.selectionEnd = newPos + (selectedText || placeholder).length;
            textarea.focus();
        }

        // åœ¨å¯ç¼–è¾‘å†…å®¹ä¸­æ’å…¥æ–‡æœ¬
        function insertIntoContentEditable(before, after, placeholder) {
            const editor = document.getElementById('wysiwygEditor');
            editor.focus();
            
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                const selectedText = range.toString();
                
                range.deleteContents();
                
                const textNode = document.createTextNode(before + (selectedText || placeholder) + after);
                range.insertNode(textNode);
                
                // è®¾ç½®æ–°çš„é€‰æ‹©èŒƒå›´
                const newRange = document.createRange();
                newRange.setStart(textNode, before.length);
                newRange.setEnd(textNode, before.length + (selectedText || placeholder).length);
                
                selection.removeAllRanges();
                selection.addRange(newRange);
            }
        }

        // åœ¨ç¼–è¾‘å™¨ä¸­æ’å…¥å¾…åŠäº‹é¡¹
        function insertTodoIntoEditor(completed) {
            const editor = document.getElementById('wysiwygEditor');
            editor.focus();
            
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                
                // æŸ¥æ‰¾å½“å‰è¡Œçš„æ–‡æœ¬å†…å®¹
                let currentElement = range.startContainer;
                if (currentElement.nodeType === Node.TEXT_NODE) {
                    currentElement = currentElement.parentElement;
                }
                
                // æ£€æŸ¥æ˜¯å¦åœ¨æ®µè½æˆ–åˆ—è¡¨é¡¹ä¸­
                let lineElement = currentElement;
                while (lineElement && lineElement !== editor && 
                       !['P', 'LI', 'H1', 'H2', 'H3', 'DIV'].includes(lineElement.tagName)) {
                    lineElement = lineElement.parentElement;
                }
                
                if (lineElement && lineElement !== editor) {
                    // è·å–å½“å‰è¡Œçš„æ–‡æœ¬å†…å®¹
                    const currentText = lineElement.textContent.trim();
                    
                                         if (currentText && currentText.length > 0) {
                         // å¦‚æœå½“å‰è¡Œæœ‰å†…å®¹ï¼Œå°†å…¶è½¬æ¢ä¸ºå¾…åŠäº‹é¡¹ (é»˜è®¤æœªå®ŒæˆçŠ¶æ€)
                         const todoHtml = `
                             <li class="todo-item">
                                 <input type="checkbox" class="todo-checkbox"> 
                                 <span>${currentText}</span>
                             </li>
                         `;
                        
                        // å¦‚æœçˆ¶å…ƒç´ ä¸æ˜¯ulï¼Œéœ€è¦åˆ›å»ºulåŒ…è£…
                        if (lineElement.parentElement.tagName !== 'UL' || 
                            !lineElement.parentElement.classList.contains('todo-list')) {
                            const ul = document.createElement('ul');
                            ul.className = 'todo-list';
                            ul.innerHTML = todoHtml;
                            lineElement.parentElement.replaceChild(ul, lineElement);
                        } else {
                            // å¦‚æœå·²ç»åœ¨todo-listä¸­ï¼Œç›´æ¥æ›¿æ¢
                            lineElement.outerHTML = todoHtml;
                        }
                        return;
                    }
                }
            }
            
            // å¦‚æœæ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„è¡Œæˆ–è¡Œä¸ºç©ºï¼Œæ’å…¥æ–°çš„å¾…åŠäº‹é¡¹
            const todoHtml = `
                <ul class="todo-list">
                    <li class="todo-item">
                        <input type="checkbox" class="todo-checkbox" ${completed ? 'checked' : ''}> 
                        <span ${completed ? 'class="todo-completed"' : ''}>å¾…åŠäº‹é¡¹</span>
                    </li>
                </ul>
            `;
            
            document.execCommand('insertHTML', false, todoHtml);
        }

        // è¯•ç”¨ç¤ºä¾‹
        function tryExample(index) {
            if (isSourceMode) {
                document.getElementById('sourceEditor').value = examples[index];
            } else {
                document.getElementById('wysiwygEditor').innerHTML = renderMarkdownToHtml(examples[index]);
            }
        }

        // å°†Markdownè½¬æ¢ä¸ºHTML
        function renderMarkdownToHtml(markdown) {
            if (!markdown.trim()) return '';
            
            let html = markdown
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                
                // å¤„ç†æ ‡é¢˜
                .replace(/^### (.+)$/gm, '<h3>$1</h3>')
                .replace(/^## (.+)$/gm, '<h2>$1</h2>')
                .replace(/^# (.+)$/gm, '<h1>$1</h1>')
                
                // å¤„ç†åˆ†éš”çº¿
                .replace(/^---$/gm, '<hr>')
                
                // å¤„ç†å¼•ç”¨
                .replace(/^> (.+)$/gm, '<blockquote>$1</blockquote>')
                
                // å¤„ç†å¾…åŠäº‹é¡¹
                .replace(/^- \[ \] (.+)$/gm, '<li class="todo-item"><input type="checkbox" class="todo-checkbox"> <span>$1</span></li>')
                .replace(/^- \[x\] (.+)$/gm, '<li class="todo-item"><input type="checkbox" class="todo-checkbox" checked> <span class="todo-completed">$1</span></li>')
                
                // å¤„ç†æ™®é€šåˆ—è¡¨
                .replace(/^- (.+)$/gm, '<li>$1</li>')
                .replace(/^(\d+)\. (.+)$/gm, '<li>$2</li>')
                
                // å¤„ç†è¡Œå†…ä»£ç 
                .replace(/`([^`]+)`/g, '<code>$1</code>')
                
                // å¤„ç†ç²—ä½“
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                
                // å¤„ç†æ–œä½“
                .replace(/\*(.+?)\*/g, '<em>$1</em>')
                
                // å¤„ç†æ®µè½
                .split('\n\n').map(paragraph => {
                    if (paragraph.includes('<h1>') || paragraph.includes('<h2>') || paragraph.includes('<h3>') ||
                        paragraph.includes('<li>') || paragraph.includes('<blockquote>') || 
                        paragraph.includes('<hr>')) {
                        return paragraph;
                    }
                    return paragraph.trim() ? `<p>${paragraph.replace(/\n/g, '<br>')}</p>` : '';
                }).join('\n');
            
            // åŒ…è£…åˆ—è¡¨
            html = html.replace(/(<li(?:[^>]*)>.*?<\/li>)(\s*<li(?:[^>]*)>.*?<\/li>)*/gs, function(match) {
                if (match.includes('todo-item')) {
                    return '<ul class="todo-list">' + match.replace(/\s*(?=<li)/g, '') + '</ul>';
                } else {
                    return '<ul>' + match.replace(/\s*(?=<li)/g, '') + '</ul>';
                }
            });
            
            return html;
        }

        // å°†HTMLè½¬æ¢ä¸ºMarkdown
        function htmlToMarkdown(html) {
            // åˆ›å»ºä¸´æ—¶å…ƒç´ 
            const temp = document.createElement('div');
            temp.innerHTML = html;
            
            let markdown = '';
            
            function processNode(node) {
                if (node.nodeType === Node.TEXT_NODE) {
                    return node.textContent;
                }
                
                if (node.nodeType === Node.ELEMENT_NODE) {
                    switch (node.tagName.toLowerCase()) {
                        case 'h1':
                            return '# ' + node.textContent + '\n\n';
                        case 'h2':
                            return '## ' + node.textContent + '\n\n';
                        case 'h3':
                            return '### ' + node.textContent + '\n\n';
                        case 'p':
                            return node.textContent + '\n\n';
                        case 'strong':
                            return '**' + node.textContent + '**';
                        case 'em':
                            return '*' + node.textContent + '*';
                        case 'code':
                            return '`' + node.textContent + '`';
                        case 'blockquote':
                            return '> ' + node.textContent + '\n\n';
                        case 'hr':
                            return '---\n\n';
                        case 'ul':
                            let result = '';
                            for (let child of node.children) {
                                if (child.classList.contains('todo-item')) {
                                    const checkbox = child.querySelector('input[type="checkbox"]');
                                    const checked = checkbox && checkbox.checked;
                                    const text = child.querySelector('span').textContent;
                                    result += (checked ? '- [x] ' : '- [ ] ') + text + '\n';
                                } else {
                                    result += '- ' + child.textContent + '\n';
                                }
                            }
                            return result + '\n';
                        case 'ol':
                            let olResult = '';
                            let index = 1;
                            for (let child of node.children) {
                                olResult += index + '. ' + child.textContent + '\n';
                                index++;
                            }
                            return olResult + '\n';
                        default:
                            let content = '';
                            for (let child of node.childNodes) {
                                content += processNode(child);
                            }
                            return content;
                    }
                }
                return '';
            }
            
            for (let child of temp.childNodes) {
                markdown += processNode(child);
            }
            
            return markdown.trim();
        }

        // å¤„ç†å¾…åŠäº‹é¡¹ç‚¹å‡»
        document.addEventListener('change', function(e) {
            if (e.target.classList.contains('todo-checkbox') && !isSourceMode) {
                const span = e.target.nextElementSibling;
                if (e.target.checked) {
                    span.classList.add('todo-completed');
                } else {
                    span.classList.remove('todo-completed');
                }
            }
        });

        // æ’¤é”€åŠŸèƒ½
        function undo() {
            if (historyIndex > 0) {
                historyIndex--;
                isUndoRedo = true;
                
                if (isSourceMode) {
                    document.getElementById('sourceEditor').value = history[historyIndex];
                } else {
                    document.getElementById('wysiwygEditor').innerHTML = history[historyIndex];
                }
                
                setTimeout(() => { isUndoRedo = false; }, 100);
            }
        }

        // é‡åšåŠŸèƒ½
        function redo() {
            if (historyIndex < history.length - 1) {
                historyIndex++;
                isUndoRedo = true;
                
                if (isSourceMode) {
                    document.getElementById('sourceEditor').value = history[historyIndex];
                } else {
                    document.getElementById('wysiwygEditor').innerHTML = history[historyIndex];
                }
                
                setTimeout(() => { isUndoRedo = false; }, 100);
            }
        }

        // ä¿å­˜å†å²çŠ¶æ€
        function saveHistory() {
            if (isUndoRedo) return;
            
            const content = isSourceMode ? 
                document.getElementById('sourceEditor').value : 
                document.getElementById('wysiwygEditor').innerHTML;
            
            // å¦‚æœå†…å®¹ä¸ä¸Šæ¬¡ç›¸åŒï¼Œä¸ä¿å­˜
            if (history[historyIndex] === content) return;
            
            // æ¸…é™¤å½“å‰ä½ç½®ä¹‹åçš„å†å²
            history = history.slice(0, historyIndex + 1);
            
            // æ·»åŠ æ–°çŠ¶æ€
            history.push(content);
            historyIndex++;
            
            // é™åˆ¶å†å²è®°å½•æ•°é‡
            if (history.length > 50) {
                history.shift();
                historyIndex--;
            }
        }

        // åˆå§‹åŒ–å†å²è®°å½•
        function initHistory() {
            const initialContent = document.getElementById('wysiwygEditor').innerHTML;
            history.push(initialContent);
            historyIndex = 0;
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initHistory();
            
            // ç›‘å¬å†…å®¹å˜åŒ–
            const wysiwygEditor = document.getElementById('wysiwygEditor');
            const sourceEditor = document.getElementById('sourceEditor');
            
            let saveTimeout;
            
            wysiwygEditor.addEventListener('input', function() {
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(saveHistory, 500);
            });
            
            sourceEditor.addEventListener('input', function() {
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(saveHistory, 500);
            });
        });

        // å…¨å±€é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', function(e) {
            // Ctrl+Z æ’¤é”€
            if (e.ctrlKey && e.key === 'z' && !e.shiftKey) {
                e.preventDefault();
                undo();
            }
            // Ctrl+Y æˆ– Ctrl+Shift+Z é‡åš
            else if ((e.ctrlKey && e.key === 'y') || (e.ctrlKey && e.shiftKey && e.key === 'Z')) {
                e.preventDefault();
                redo();
            }
            // Ctrl+A å…¨é€‰
            else if (e.ctrlKey && e.key === 'a') {
                if (isSourceMode) {
                    // æºç æ¨¡å¼ä¸‹è®©é»˜è®¤è¡Œä¸ºå¤„ç†
                    return;
                } else {
                    // WYSIWYGæ¨¡å¼ä¸‹å…¨é€‰
                    e.preventDefault();
                    const selection = window.getSelection();
                    const range = document.createRange();
                    range.selectNodeContents(document.getElementById('wysiwygEditor'));
                    selection.removeAllRanges();
                    selection.addRange(range);
                }
            }
            // Ctrl+S ä¿å­˜ï¼ˆè¿™é‡Œå¯ä»¥æ‰©å±•ä¸ºå®é™…ä¿å­˜åŠŸèƒ½ï¼‰
            else if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                alert('ä¿å­˜åŠŸèƒ½å¯ä»¥åœ¨è¿™é‡Œå®ç°ï¼');
            }
        });

        // æ”¹è¿›Tabé”®å’Œç¼©è¿›å¤„ç†
        document.getElementById('sourceEditor').addEventListener('keydown', function(e) {
            if (e.key === 'Tab') {
                e.preventDefault();
                const start = this.selectionStart;
                const end = this.selectionEnd;
                
                if (e.shiftKey) {
                    // Shift+Tab å‡å°‘ç¼©è¿›
                    const lines = this.value.split('\n');
                    let startLine = 0;
                    let endLine = 0;
                    let currentPos = 0;
                    
                    // æ‰¾åˆ°é€‰ä¸­åŒºåŸŸçš„è¡Œ
                    for (let i = 0; i < lines.length; i++) {
                        if (currentPos <= start && currentPos + lines[i].length >= start) {
                            startLine = i;
                        }
                        if (currentPos <= end && currentPos + lines[i].length >= end) {
                            endLine = i;
                            break;
                        }
                        currentPos += lines[i].length + 1;
                    }
                    
                    // å‡å°‘ç¼©è¿›
                    for (let i = startLine; i <= endLine; i++) {
                        if (lines[i].startsWith('    ')) {
                            lines[i] = lines[i].substring(4);
                        } else if (lines[i].startsWith('\t')) {
                            lines[i] = lines[i].substring(1);
                        }
                    }
                    
                    this.value = lines.join('\n');
                } else {
                    // Tab å¢åŠ ç¼©è¿›
                    if (start === end) {
                        // æ²¡æœ‰é€‰ä¸­æ–‡æœ¬ï¼Œæ’å…¥4ä¸ªç©ºæ ¼
                        this.value = this.value.substring(0, start) + '    ' + this.value.substring(end);
                        this.selectionStart = this.selectionEnd = start + 4;
                    } else {
                        // æœ‰é€‰ä¸­æ–‡æœ¬ï¼Œå¯¹é€‰ä¸­çš„æ¯è¡Œå¢åŠ ç¼©è¿›
                        const lines = this.value.split('\n');
                        let startLine = 0;
                        let endLine = 0;
                        let currentPos = 0;
                        
                        // æ‰¾åˆ°é€‰ä¸­åŒºåŸŸçš„è¡Œ
                        for (let i = 0; i < lines.length; i++) {
                            if (currentPos <= start && currentPos + lines[i].length >= start) {
                                startLine = i;
                            }
                            if (currentPos <= end && currentPos + lines[i].length >= end) {
                                endLine = i;
                                break;
                            }
                            currentPos += lines[i].length + 1;
                        }
                        
                        // å¢åŠ ç¼©è¿›
                        for (let i = startLine; i <= endLine; i++) {
                            lines[i] = '    ' + lines[i];
                        }
                        
                        this.value = lines.join('\n');
                        this.selectionStart = start + 4;
                        this.selectionEnd = end + 4 * (endLine - startLine + 1);
                    }
                }
                
                // è§¦å‘è¾“å…¥äº‹ä»¶ä»¥ä¿å­˜å†å²
                this.dispatchEvent(new Event('input'));
            }
            // Enteré”®è‡ªåŠ¨ç¼©è¿›
            else if (e.key === 'Enter') {
                const start = this.selectionStart;
                const lines = this.value.substring(0, start).split('\n');
                const currentLine = lines[lines.length - 1];
                
                // æ£€æµ‹å½“å‰è¡Œçš„ç¼©è¿›
                const indentMatch = currentLine.match(/^(\s*)/);
                if (indentMatch) {
                    const indent = indentMatch[1];
                    
                    // å¦‚æœå½“å‰è¡Œæ˜¯åˆ—è¡¨é¡¹ï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦è‡ªåŠ¨ç»§ç»­åˆ—è¡¨
                    const listMatch = currentLine.match(/^(\s*)([-*+]|\d+\.)\s/);
                    if (listMatch) {
                        const listIndent = listMatch[1];
                        const listMarker = listMatch[2];
                        
                        setTimeout(() => {
                            const currentPos = this.selectionStart;
                            let newMarker = listMarker;
                            
                            // å¦‚æœæ˜¯æ•°å­—åˆ—è¡¨ï¼Œé€’å¢æ•°å­—
                            if (/\d+\./.test(listMarker)) {
                                const num = parseInt(listMarker) + 1;
                                newMarker = num + '.';
                            }
                            
                            const newListItem = listIndent + newMarker + ' ';
                            this.value = this.value.substring(0, currentPos) + newListItem + this.value.substring(currentPos);
                            this.selectionStart = this.selectionEnd = currentPos + newListItem.length;
                            
                            this.dispatchEvent(new Event('input'));
                        }, 0);
                    } else if (indent) {
                        // æ™®é€šç¼©è¿›å»¶ç»­
                        setTimeout(() => {
                            const currentPos = this.selectionStart;
                            this.value = this.value.substring(0, currentPos) + indent + this.value.substring(currentPos);
                            this.selectionStart = this.selectionEnd = currentPos + indent.length;
                            
                            this.dispatchEvent(new Event('input'));
                        }, 0);
                    }
                }
            }
        });
    </script>
</body>
</html> 